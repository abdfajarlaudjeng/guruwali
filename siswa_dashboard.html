<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéì Dashboard Siswa</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">

<div class="max-w-5xl mx-auto mt-10 bg-white p-6 rounded-xl shadow-lg">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-blue-700">üéì Dashboard Siswa</h2>
    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
  </div>

  <!-- Profil -->
  <section id="profilSection" class="mb-8">
    <h3 class="text-lg font-semibold text-gray-800 mb-2">üë§ Profil Siswa</h3>
    <div id="profilData" class="bg-gray-50 p-4 rounded border border-gray-200"></div>
  </section>

  <!-- Grafik -->
  <section id="grafikSection" class="mb-10">
    <h3 class="text-lg font-semibold text-gray-800 mb-2">üìà Grafik Nilai Assessment</h3>
    <div class="bg-gray-50 p-4 rounded border border-gray-200">
      <canvas id="nilaiChart" height="120"></canvas>
      <p id="noChartData" class="text-gray-500 text-sm hidden mt-2">Belum ada data grafik untuk ditampilkan.</p>
    </div>
  </section>

  <!-- Assessment -->
  <section id="assessmentSection" class="mb-8">
    <h3 class="text-lg font-semibold text-gray-800 mb-2">üìä Riwayat Assessment</h3>
    <div id="assessmentList" class="overflow-x-auto bg-gray-50 p-4 rounded border border-gray-200 text-sm"></div>
  </section>

  <!-- Bimbingan -->
  <section id="bimbinganSection">
    <h3 class="text-lg font-semibold text-gray-800 mb-2">üóÇÔ∏è Riwayat Bimbingan</h3>
    <div id="bimbinganList" class="overflow-x-auto bg-gray-50 p-4 rounded border border-gray-200 text-sm"></div>
  </section>
</div>

<script>
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyjLMy1W6tRvz8zmdAYBxqkJPyIDSV7Wsx8b77amR7xbvyEWI2uZ9suZzmkU5sSaEqt/exec';

// Cek login
const userId = localStorage.getItem('userId');
const userRole = localStorage.getItem('userRole');
if (!userId || userRole !== "Siswa") {
  alert("Akses ditolak. Silakan login sebagai Siswa.");
  window.location.href = "index.html";
}

// Logout
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.clear();
  window.location.href = "index.html";
});

// Ambil data siswa
async function loadSiswaData() {
  const payload = { action: "getSiswaData", id_siswa: userId };
  try {
    const response = await fetch(GAS_WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const result = await response.json();

    if (result.status === "success") {
      showProfil(result.profil);
      showAssessment(result.assessments);
      showBimbingan(result.bimbingan);
      renderChart(result.assessments);
    } else {
      document.getElementById("profilData").innerHTML = `<p class='text-red-600'>${result.message}</p>`;
    }
  } catch (error) {
    console.error("Fetch Error:", error);
    document.getElementById("profilData").innerHTML = `<p class='text-red-600'>Gagal memuat data siswa.</p>`;
  }
}

// Profil
function showProfil(p) {
  document.getElementById("profilData").innerHTML = `
    <table class="w-full text-sm">
      <tr><td class="font-semibold w-1/3">ID Siswa</td><td>${p.id_user}</td></tr>
      <tr><td class="font-semibold">Nama Lengkap</td><td>${p.nama_lengkap}</td></tr>
      <tr><td class="font-semibold">Kelas</td><td>${p.id_kelas}</td></tr>
      <tr><td class="font-semibold">Role</td><td>${p.role}</td></tr>
    </table>
  `;
}

// Assessment Table
function showAssessment(data) {
  if (!data || data.length === 0) {
    document.getElementById("assessmentList").innerHTML = `<p class="text-gray-500">Belum ada data assessment.</p>`;
    return;
  }
  let html = `<table class="min-w-full border-collapse border text-left">
                <thead><tr class="bg-blue-100">
                  ${Object.keys(data[0]).map(h => `<th class="border px-2 py-1">${h}</th>`).join("")}
                </tr></thead><tbody>`;
  data.forEach(row => {
    html += `<tr>${Object.values(row).map(v => `<td class="border px-2 py-1">${v}</td>`).join("")}</tr>`;
  });
  html += "</tbody></table>";
  document.getElementById("assessmentList").innerHTML = html;
}

// Bimbingan Table
function showBimbingan(data) {
  if (!data || data.length === 0) {
    document.getElementById("bimbinganList").innerHTML = `<p class="text-gray-500">Belum ada data bimbingan.</p>`;
    return;
  }
  let html = `<table class="min-w-full border-collapse border text-left">
                <thead><tr class="bg-green-100">
                  ${Object.keys(data[0]).map(h => `<th class="border px-2 py-1">${h}</th>`).join("")}
                </tr></thead><tbody>`;
  data.forEach(row => {
    html += `<tr>${Object.values(row).map(v => `<td class="border px-2 py-1">${v}</td>`).join("")}</tr>`;
  });
  html += "</tbody></table>";
  document.getElementById("bimbinganList").innerHTML = html;
}

// Grafik Chart.js
function renderChart(assessments) {
  if (!assessments || assessments.length === 0) {
    document.getElementById("noChartData").classList.remove("hidden");
    return;
  }

  // Cari kolom yang relevan
  const subjects = [];
  const scores = [];
  assessments.forEach(a => {
    const mapel = a["Mata Pelajaran"] || a["Mapel"] || a["Pelajaran"];
    const nilai = parseFloat(a["Nilai"] || a["Skor"] || 0);
    if (mapel && !isNaN(nilai)) {
      subjects.push(mapel);
      scores.push(nilai);
    }
  });

  if (subjects.length === 0) {
    document.getElementById("noChartData").classList.remove("hidden");
    return;
  }

  const ctx = document.getElementById("nilaiChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: subjects,
      datasets: [{
        label: "Nilai Assessment",
        data: scores,
        backgroundColor: "rgba(37, 99, 235, 0.6)",
        borderColor: "rgba(37, 99, 235, 1)",
        borderWidth: 1
      }]
    },
    options: {
      scales: { y: { beginAtZero: true, max: 100 } },
      plugins: { legend: { display: false } }
    }
  });
}

// Jalankan saat halaman dimuat
loadSiswaData();
</script>
</body>
</html>
